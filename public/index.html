<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Cloud Agents - Supervisor Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0; top: 0; bottom: 0;
      width: 240px;
      background: #161b22;
      border-right: 1px solid #30363d;
      padding: 20px 0;
    }
    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid #30363d;
      margin-bottom: 10px;
    }
    .sidebar-header h1 {
      font-size: 16px;
      color: #58a6ff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sidebar-header .status {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #3fb950;
    }
    .sidebar-header .status.offline { background: #f85149; }
    .sidebar-header p { font-size: 11px; color: #8b949e; margin-top: 4px; }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      color: #8b949e;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }
    .nav-item:hover { background: #1f2428; color: #c9d1d9; }
    .nav-item.active { background: #1f2428; color: #58a6ff; border-left-color: #58a6ff; }
    .nav-item .badge {
      margin-left: auto;
      background: #f85149;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* Main Content */
    .main {
      margin-left: 240px;
      padding: 30px;
      min-height: 100vh;
    }

    .page { display: none; }
    .page.active { display: block; }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    .page-header h2 { font-size: 24px; color: #c9d1d9; }

    /* Stats Row */
    .stats { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
    .stat {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      min-width: 150px;
      flex: 1;
    }
    .stat-value { font-size: 28px; font-weight: 600; color: #c9d1d9; }
    .stat-label { font-size: 12px; color: #8b949e; margin-top: 4px; }
    .stat.success .stat-value { color: #3fb950; }
    .stat.danger .stat-value { color: #f85149; }
    .stat.warning .stat-value { color: #d29922; }

    /* Cards */
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .card-header {
      padding: 15px 20px;
      border-bottom: 1px solid #30363d;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-header h3 { font-size: 14px; color: #c9d1d9; }
    .card-body { padding: 20px; }
    .card.blocked { border-color: #f85149; }
    .card.success { border-color: #3fb950; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #21262d; }
    th { color: #8b949e; font-size: 11px; text-transform: uppercase; font-weight: 600; }
    tr:hover { background: #1f2428; }

    /* Badges */
    .badge-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-status.blocked { background: #f8514922; color: #f85149; }
    .badge-status.pending { background: #d2992222; color: #d29922; }
    .badge-status.completed { background: #3fb95022; color: #3fb950; }
    .badge-status.stopped { background: #f8514922; color: #f85149; }

    .score { font-weight: 600; font-family: monospace; }
    .score.low { color: #3fb950; }
    .score.medium { color: #d29922; }
    .score.high { color: #f85149; }
    .score.critical { color: #ff7b72; background: #f8514922; padding: 2px 6px; border-radius: 4px; }

    .reason-tag {
      display: inline-block;
      background: #30363d;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      margin: 1px;
      font-family: monospace;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn-primary { background: #238636; color: white; }
    .btn-primary:hover { background: #2ea043; }
    .btn-danger { background: #da3633; color: white; }
    .btn-danger:hover { background: #f85149; }
    .btn-secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
    .btn-secondary:hover { background: #30363d; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }

    .actions { display: flex; gap: 6px; }

    /* Forms */
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: #8b949e;
      font-size: 13px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #c9d1d9;
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #58a6ff;
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: flex; gap: 15px; }
    .form-row .form-group { flex: 1; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h3 { font-size: 18px; }
    .modal-close {
      background: none;
      border: none;
      color: #8b949e;
      font-size: 24px;
      cursor: pointer;
    }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

    /* Empty State */
    .empty {
      text-align: center;
      padding: 40px;
      color: #8b949e;
    }
    .empty-icon { font-size: 48px; margin-bottom: 10px; opacity: 0.5; }

    /* Timestamp */
    .timestamp { color: #8b949e; font-size: 12px; }

    /* Grid */
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    @media (max-width: 1200px) { .grid-2 { grid-template-columns: 1fr; } }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px 20px;
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 200;
    }
    .toast.active { display: flex; }
    .toast.success { border-color: #3fb950; }
    .toast.error { border-color: #f85149; }

    code { background: #30363d; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1><span class="status" id="serverStatus"></span> Cloud Agents</h1>
      <p>Engineering Lead Supervisor</p>
    </div>
    <nav>
      <div class="nav-item active" data-page="dashboard">
        <span>üìä</span> Dashboard
      </div>
      <div class="nav-item" data-page="tasks">
        <span>üìã</span> Tasks
      </div>
      <div class="nav-item" data-page="blocked">
        <span>‚ö†Ô∏è</span> Blocked
        <span class="badge" id="blockedBadge" style="display:none">0</span>
      </div>
      <div class="nav-item" data-page="audit">
        <span>üìú</span> Audit Log
      </div>
      <div class="nav-item" data-page="settings">
        <span>‚öôÔ∏è</span> Einstellungen
      </div>
    </nav>
  </aside>

  <main class="main">
    <!-- Dashboard Page -->
    <section class="page active" id="page-dashboard">
      <div class="page-header">
        <h2>Dashboard</h2>
        <button class="btn btn-secondary" onclick="refreshAll()">Aktualisieren</button>
      </div>

      <div class="stats">
        <div class="stat success" id="statHealth">
          <div class="stat-value">-</div>
          <div class="stat-label">System Status</div>
        </div>
        <div class="stat danger" id="statBlocked">
          <div class="stat-value">0</div>
          <div class="stat-label">Blocked Tasks</div>
        </div>
        <div class="stat" id="statTasks">
          <div class="stat-value">0</div>
          <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat" id="statCompleted">
          <div class="stat-value">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat warning" id="statAvgScore">
          <div class="stat-value">0</div>
          <div class="stat-label">Avg Stop Score</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card" id="recentBlockedCard">
          <div class="card-header">
            <h3>‚ö†Ô∏è Awaiting Approval</h3>
          </div>
          <div class="card-body" id="recentBlocked"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>üìú Recent Audit</h3>
          </div>
          <div class="card-body" id="recentAudit"></div>
        </div>
      </div>
    </section>

    <!-- Tasks Page -->
    <section class="page" id="page-tasks">
      <div class="page-header">
        <h2>Tasks</h2>
        <button class="btn btn-primary" onclick="openNewTaskModal()">+ Neuer Task</button>
      </div>

      <div class="card">
        <div class="card-body" id="tasksList"></div>
      </div>
    </section>

    <!-- Blocked Page -->
    <section class="page" id="page-blocked">
      <div class="page-header">
        <h2>Blocked Tasks</h2>
      </div>

      <div class="card blocked" id="blockedCard">
        <div class="card-body" id="blockedList"></div>
      </div>
    </section>

    <!-- Audit Page -->
    <section class="page" id="page-audit">
      <div class="page-header">
        <h2>Audit Log</h2>
      </div>

      <div class="stats">
        <div class="stat" id="auditTotal">
          <div class="stat-value">0</div>
          <div class="stat-label">Total Decisions</div>
        </div>
        <div class="stat danger" id="auditStopped">
          <div class="stat-value">0</div>
          <div class="stat-label">Stopped</div>
        </div>
        <div class="stat success" id="auditApproved">
          <div class="stat-value">0</div>
          <div class="stat-label">Approved</div>
        </div>
      </div>

      <div class="card">
        <div class="card-body" id="auditList"></div>
      </div>
    </section>

    <!-- Settings Page -->
    <section class="page" id="page-settings">
      <div class="page-header">
        <h2>Einstellungen</h2>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>System Info</h3>
        </div>
        <div class="card-body" id="systemInfo">
          <p><strong>Version:</strong> 0.1.0</p>
          <p><strong>Supervisor:</strong> ENGINEERING_LEAD_SUPERVISOR</p>
          <p><strong>Mode:</strong> SUPERVISED</p>
          <p><strong>Stop Threshold:</strong> 40</p>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>STOP Score Schwellenwerte</h3>
        </div>
        <div class="card-body">
          <table>
            <tr><td>PRICING_WITHOUT_FACT</td><td class="score critical">+40</td></tr>
            <tr><td>LEGAL_STATEMENT</td><td class="score critical">+40</td></tr>
            <tr><td>UNPROVEN_CLAIM</td><td class="score high">+30</td></tr>
            <tr><td>CROSS_LAYER_MISMATCH</td><td class="score high">+25</td></tr>
            <tr><td>MISSING_SQL_OR_SCHEMA</td><td class="score high">+25</td></tr>
            <tr><td>COST_OR_LOAD_RISK</td><td class="score medium">+20</td></tr>
            <tr><td>MISSING_TESTS</td><td class="score medium">+15</td></tr>
            <tr><td>MISSING_DEPLOY_CONFIG</td><td class="score medium">+15</td></tr>
          </table>
          <p style="margin-top: 15px; color: #8b949e; font-size: 12px;">
            Score >= 40 = STOP_REQUIRED (Task wird blockiert)
          </p>
        </div>
      </div>
    </section>
  </main>

  <!-- New Task Modal -->
  <div class="modal" id="newTaskModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Neuer Task erstellen</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <form id="newTaskForm">
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" id="taskTitle" required placeholder="Task-Titel eingeben">
        </div>
        <div class="form-group">
          <label>Beschreibung</label>
          <textarea id="taskDesc" placeholder="Optionale Beschreibung"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Priorit√§t</label>
            <select id="taskPriority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Artefakte (kommasepariert)</label>
          <input type="text" id="taskArtefacts" placeholder="src/file.ts, tests/test.ts">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Task erstellen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Approve Modal -->
  <div class="modal" id="approveModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Task genehmigen</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <p style="margin-bottom:15px">Task: <code id="approveTaskId"></code></p>
      <form id="approveForm">
        <div class="form-group">
          <label>Approver (Email/Name) *</label>
          <input type="text" id="approver" required placeholder="max@example.com">
        </div>
        <div class="form-group">
          <label>Begr√ºndung (min 10 Zeichen) *</label>
          <textarea id="reason" required placeholder="Warum wird trotz STOP genehmigt?"></textarea>
        </div>
        <div class="form-group">
          <label>Akzeptierte Risiken *</label>
          <input type="text" id="risks" required placeholder="Risiko1, Risiko2, ...">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Genehmigen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reject Modal -->
  <div class="modal" id="rejectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Task ablehnen</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <p style="margin-bottom:15px">Task: <code id="rejectTaskId"></code></p>
      <form id="rejectForm">
        <div class="form-group">
          <label>Rejector (Email/Name) *</label>
          <input type="text" id="rejector" required placeholder="max@example.com">
        </div>
        <div class="form-group">
          <label>Begr√ºndung (min 10 Zeichen) *</label>
          <textarea id="rejectReason" required placeholder="Warum wird abgelehnt?"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
          <button type="submit" class="btn btn-danger">Ablehnen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <span id="toastMsg"></span>
  </div>

  <script>
    const API = '';
    let currentTaskId = null;

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const page = item.dataset.page;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        item.classList.add('active');
        document.getElementById('page-' + page).classList.add('active');
      });
    });

    // Toast
    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      toast.className = `toast active ${type}`;
      document.getElementById('toastMsg').textContent = msg;
      setTimeout(() => toast.classList.remove('active'), 3000);
    }

    // Fetch functions
    async function fetchHealth() {
      try {
        const res = await fetch(`${API}/health`);
        const data = await res.json();
        document.getElementById('serverStatus').className =
          `status ${data.status === 'healthy' ? '' : 'offline'}`;
        document.querySelector('#statHealth .stat-value').textContent =
          data.status === 'healthy' ? 'Healthy' : 'Offline';
      } catch (e) {
        document.getElementById('serverStatus').className = 'status offline';
        document.querySelector('#statHealth .stat-value').textContent = 'Offline';
      }
    }

    async function fetchBlocked() {
      try {
        const res = await fetch(`${API}/api/enforcement/blocked`);
        const data = await res.json();

        document.querySelector('#statBlocked .stat-value').textContent = data.blocked_count;
        const badge = document.getElementById('blockedBadge');
        if (data.blocked_count > 0) {
          badge.style.display = 'block';
          badge.textContent = data.blocked_count;
        } else {
          badge.style.display = 'none';
        }

        const renderBlocked = (container, limit = 100) => {
          if (data.blocked_count === 0) {
            return '<div class="empty"><div class="empty-icon">‚úì</div>Keine blockierten Tasks</div>';
          }
          return `<table>
            <thead><tr><th>Task ID</th><th>Score</th><th>Reasons</th><th>Blocked</th><th>Actions</th></tr></thead>
            <tbody>
              ${data.tasks.slice(0, limit).map(t => `<tr>
                <td><code>${t.taskId.slice(0,8)}...</code></td>
                <td><span class="score ${getScoreClass(t.stopScore)}">${t.stopScore}</span></td>
                <td>${t.reasons.map(r => `<span class="reason-tag">${r}</span>`).join('')}</td>
                <td class="timestamp">${formatDate(t.blockedAt)}</td>
                <td class="actions">
                  <button class="btn btn-primary btn-sm" onclick="openApprove('${t.taskId}')">Approve</button>
                  <button class="btn btn-danger btn-sm" onclick="openReject('${t.taskId}')">Reject</button>
                </td>
              </tr>`).join('')}
            </tbody>
          </table>`;
        };

        document.getElementById('recentBlocked').innerHTML = renderBlocked('', 3);
        document.getElementById('blockedList').innerHTML = renderBlocked('', 100);

        if (data.blocked_count > 0) {
          document.getElementById('recentBlockedCard').classList.add('blocked');
          document.getElementById('blockedCard').classList.add('blocked');
        } else {
          document.getElementById('recentBlockedCard').classList.remove('blocked');
          document.getElementById('blockedCard').classList.remove('blocked');
        }
      } catch (e) {
        document.getElementById('recentBlocked').innerHTML = '<div class="empty">Fehler</div>';
      }
    }

    async function fetchTasks() {
      try {
        const res = await fetch(`${API}/api/tasks`);
        const data = await res.json();

        document.querySelector('#statTasks .stat-value').textContent = data.count;
        const completed = data.tasks.filter(t => t.status === 'completed').length;
        document.querySelector('#statCompleted .stat-value').textContent = completed;

        if (data.count === 0) {
          document.getElementById('tasksList').innerHTML =
            '<div class="empty"><div class="empty-icon">üìã</div>Keine Tasks vorhanden</div>';
        } else {
          document.getElementById('tasksList').innerHTML = `<table>
            <thead><tr><th>Titel</th><th>Status</th><th>Priorit√§t</th><th>Score</th><th>Erstellt</th></tr></thead>
            <tbody>
              ${data.tasks.map(t => `<tr>
                <td>${t.title}</td>
                <td><span class="badge-status ${t.status}">${t.status}</span></td>
                <td>${t.priority}</td>
                <td>${t.stop_score !== null ? `<span class="score ${getScoreClass(t.stop_score)}">${t.stop_score}</span>` : '-'}</td>
                <td class="timestamp">${formatDate(t.created_at)}</td>
              </tr>`).join('')}
            </tbody>
          </table>`;
        }
      } catch (e) {
        document.getElementById('tasksList').innerHTML = '<div class="empty">Fehler</div>';
      }
    }

    async function fetchAudit() {
      try {
        const res = await fetch(`${API}/api/audit?limit=50`);
        const data = await res.json();

        document.querySelector('#auditTotal .stat-value').textContent = data.count;
        const stopped = data.entries.filter(e => e.decision === 'STOP_REQUIRED').length;
        const approved = data.entries.filter(e => e.decision === 'APPROVED').length;
        document.querySelector('#auditStopped .stat-value').textContent = stopped;
        document.querySelector('#auditApproved .stat-value').textContent = approved;

        const avgScore = data.count > 0
          ? (data.entries.reduce((a, e) => a + e.stop_score, 0) / data.count).toFixed(1)
          : 0;
        document.querySelector('#statAvgScore .stat-value').textContent = avgScore;

        const renderAudit = (limit) => {
          if (data.count === 0) {
            return '<div class="empty"><div class="empty-icon">üìú</div>Keine Audit-Eintr√§ge</div>';
          }
          return `<table>
            <thead><tr><th>Decision</th><th>Status</th><th>Risk</th><th>Score</th><th>Action</th><th>Time</th></tr></thead>
            <tbody>
              ${data.entries.slice(0, limit).map(e => `<tr>
                <td><span class="badge-status ${e.decision === 'APPROVED' ? 'completed' : 'stopped'}">${e.decision}</span></td>
                <td>${e.final_status}</td>
                <td><span class="score ${e.risk_level.toLowerCase()}">${e.risk_level}</span></td>
                <td><span class="score ${getScoreClass(e.stop_score)}">${e.stop_score}</span></td>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.required_next_action}</td>
                <td class="timestamp">${formatDate(e.created_at)}</td>
              </tr>`).join('')}
            </tbody>
          </table>`;
        };

        document.getElementById('recentAudit').innerHTML = renderAudit(5);
        document.getElementById('auditList').innerHTML = renderAudit(50);
      } catch (e) {
        document.getElementById('auditList').innerHTML = '<div class="empty">Fehler</div>';
      }
    }

    // Helpers
    function getScoreClass(score) {
      if (score >= 70) return 'critical';
      if (score >= 45) return 'high';
      if (score >= 20) return 'medium';
      return 'low';
    }

    function formatDate(d) {
      return new Date(d).toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'short' });
    }

    // Modals
    function closeModal() {
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
      currentTaskId = null;
    }

    function openNewTaskModal() {
      document.getElementById('newTaskModal').classList.add('active');
    }

    function openApprove(taskId) {
      currentTaskId = taskId;
      document.getElementById('approveTaskId').textContent = taskId;
      document.getElementById('approveModal').classList.add('active');
    }

    function openReject(taskId) {
      currentTaskId = taskId;
      document.getElementById('rejectTaskId').textContent = taskId;
      document.getElementById('rejectModal').classList.add('active');
    }

    // Forms
    document.getElementById('newTaskForm').onsubmit = async (e) => {
      e.preventDefault();
      const artefacts = document.getElementById('taskArtefacts').value
        .split(',').map(s => s.trim()).filter(s => s);
      const body = {
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDesc').value || undefined,
        priority: document.getElementById('taskPriority').value,
        artefacts
      };
      try {
        const res = await fetch(`${API}/api/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        closeModal();
        document.getElementById('newTaskForm').reset();
        if (data.status === 'BLOCKED') {
          showToast('Task erstellt aber BLOCKED! Score: ' + data.stop_score, 'error');
        } else {
          showToast('Task erfolgreich erstellt!');
        }
        refreshAll();
      } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
      }
    };

    document.getElementById('approveForm').onsubmit = async (e) => {
      e.preventDefault();
      const body = {
        approver: document.getElementById('approver').value,
        reason: document.getElementById('reason').value,
        acknowledged_risks: document.getElementById('risks').value.split(',').map(s => s.trim())
      };
      try {
        const res = await fetch(`${API}/api/enforcement/approve/${currentTaskId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (res.ok) {
          closeModal();
          showToast('Task genehmigt!');
          refreshAll();
        } else {
          const err = await res.json();
          showToast('Fehler: ' + (err.error || JSON.stringify(err)), 'error');
        }
      } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
      }
    };

    document.getElementById('rejectForm').onsubmit = async (e) => {
      e.preventDefault();
      const body = {
        rejector: document.getElementById('rejector').value,
        reason: document.getElementById('rejectReason').value
      };
      try {
        const res = await fetch(`${API}/api/enforcement/reject/${currentTaskId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (res.ok) {
          closeModal();
          showToast('Task abgelehnt');
          refreshAll();
        } else {
          const err = await res.json();
          showToast('Fehler: ' + (err.error || JSON.stringify(err)), 'error');
        }
      } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
      }
    };

    function refreshAll() {
      fetchHealth();
      fetchBlocked();
      fetchTasks();
      fetchAudit();
    }

    // Init
    refreshAll();
    setInterval(refreshAll, 5000);
  </script>
</body>
</html>
